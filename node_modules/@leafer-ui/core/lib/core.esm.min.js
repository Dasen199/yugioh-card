import{Leafer as t,State as e,UI as i,ImageManager as a,Rect as s,Box as n,Group as r}from"@leafer-ui/draw";export*from"@leafer-ui/draw";import{registerUI as o,Creator as h,PropertyEvent as d,Debug as c,DataHelper as l,canvasSizeAttrs as g,LayoutEvent as u,RenderEvent as p,Event as m,EventCreator as v,registerUIEvent as _,LeafList as f,BoundsHelper as D,PointHelper as y,Bounds as E,ResizeEvent as P,LeaferEvent as O,CanvasManager as T,Leaf as w,Matrix as R,Platform as x,tempBounds as C,LeaferCanvasBase as b}from"@leafer/core";function L(t,e,i,a){var s,n=arguments.length,r=n<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,a);else for(var o=t.length-1;o>=0;o--)(s=t[o])&&(r=(n<3?s(r):n>3?s(e,i,r):s(e,i))||r);return n>3&&r&&Object.defineProperty(e,i,r),r}"function"==typeof SuppressedError&&SuppressedError;let M=class extends t{get __tag(){return"App"}get isApp(){return!0}constructor(t,e){super(t,e)}init(t,e){if(super.init(t,e),t){const{ground:e,tree:i,sky:a,editor:s}=t;e&&(this.ground=this.addLeafer(e)),(i||s)&&(this.tree=this.addLeafer(i)),(a||s)&&(this.sky=this.addLeafer(a||{type:"draw",usePartRender:!1})),s&&this.sky.add(this.editor=h.editor(s))}}__setApp(){const{canvas:t}=this,{realCanvas:e,view:i}=this.config;e||i===this.canvas.view||!t.parentView?this.realCanvas=!0:t.unrealCanvas(),this.leafer=this,this.watcher.disable(),this.layouter.disable(),this.__eventIds.push(this.on_(d.CHANGE,this.__onPropertyChange,this))}start(){super.start(),this.children.forEach((t=>t.start()))}stop(){this.children.forEach((t=>t.stop())),super.stop()}unlockLayout(){super.unlockLayout(),this.children.forEach((t=>t.unlockLayout()))}lockLayout(){super.lockLayout(),this.children.forEach((t=>t.lockLayout()))}forceRender(t){this.children.forEach((e=>e.forceRender(t)))}addLeafer(e){const i=new t(e);return this.add(i),i}add(t,e){if(!t.view){if(this.realCanvas&&!this.canvas.bounds)return void setTimeout((()=>this.add(t,e)),10);t.init(this.__getChildConfig(t.userConfig),this)}super.add(t,e),void 0!==e&&(t.canvas.childIndex=e),this.__listenChildEvents(t)}__onPropertyChange(){c.showHitView&&this.children.forEach((t=>t.forceUpdate("surface")))}__onCreated(){this.created=this.children.every((t=>t.created))}__onReady(){this.children.every((t=>t.ready))&&super.__onReady()}__onViewReady(){this.children.every((t=>t.viewReady))&&super.__onViewReady()}__onChildRenderEnd(t){this.renderer.addBlock(t.renderBounds),this.viewReady&&this.renderer.update()}__render(t,e){if(t.context){if(e.matrix){const{a:i,b:a,c:s,d:n,e:r,f:o}=e.matrix;t.setTransform(i,a,s,n,r,o)}this.children.forEach((e=>t.copyWorld(e.canvas)))}}__onResize(t){this.children.forEach((e=>e.resize(t))),super.__onResize(t)}__checkUpdateLayout(){this.children.forEach((t=>t.__layout.update()))}__getChildConfig(t){let e=Object.assign({},this.config);return e.hittable=e.realCanvas=void 0,t&&l.assign(e,t),this.autoLayout&&l.copyAttrs(e,this,g),e.view=this.realCanvas?void 0:this.view,e.fill=void 0,e}__listenChildEvents(t){t.once(u.END,(()=>this.__onReady())),t.once(p.START,(()=>this.__onCreated())),t.once(p.END,(()=>this.__onViewReady())),this.realCanvas&&this.__eventIds.push(t.on_(p.END,this.__onChildRenderEnd,this))}};M=L([o()],M);const S={},k={isHoldSpaceKey:()=>k.isHold("Space"),isHold:t=>S[t],setDownCode(t){S[t]||(S[t]=!0)},setUpCode(t){S[t]=!1}},A={LEFT:1,RIGHT:2,MIDDLE:4,defaultLeft(t){t.buttons||(t.buttons=1)},left:t=>1===t.buttons,right:t=>2===t.buttons,middle:t=>4===t.buttons};class H extends m{get spaceKey(){return k.isHoldSpaceKey()}get left(){return A.left(this)}get right(){return A.right(this)}get middle(){return A.middle(this)}constructor(t){super(t.type),this.bubbles=!0,this.getInner=this.getInnerPoint,this.getLocal=this.getLocalPoint,this.getPage=this.getPagePoint,Object.assign(this,t)}getBoxPoint(t){return t||(t=this.current),t.getBoxPoint(this)}getInnerPoint(t){return t||(t=this.current),t.getInnerPoint(this)}getLocalPoint(t){return t||(t=this.current),t.getLocalPoint(this)}getPagePoint(){return this.current.getPagePoint(this)}static changeName(t,e){v.changeName(t,e)}}let B=class extends H{};B.POINTER="pointer",B.BEFORE_DOWN="pointer.before_down",B.BEFORE_MOVE="pointer.before_move",B.BEFORE_UP="pointer.before_up",B.DOWN="pointer.down",B.MOVE="pointer.move",B.UP="pointer.up",B.OVER="pointer.over",B.OUT="pointer.out",B.ENTER="pointer.enter",B.LEAVE="pointer.leave",B.TAP="tap",B.DOUBLE_TAP="double_tap",B.CLICK="click",B.DOUBLE_CLICK="double_click",B.LONG_PRESS="long_press",B.LONG_TAP="long_tap",B.MENU="pointer.menu",B.MENU_TAP="pointer.menu_tap",B=L([_()],B);const I=B,N={};let W=class extends B{static setList(t){this.list=t instanceof f?t:new f(t)}static setData(t){this.data=t}static getValidMove(t,e,i){const{draggable:a,dragBounds:s,x:n,y:r}=t,o=t.getLocalPoint(i,null,!0);return o.x+=e.x-n,o.y+=e.y-r,s&&this.getMoveInDragBounds(t.__local,"parent"===s?t.parent.boxBounds:s,o,!0),"x"===a&&(o.y=0),"y"===a&&(o.x=0),o}static getMoveInDragBounds(t,e,i,a){const s=t.x+i.x,n=t.y+i.y,r=s+t.width,o=n+t.height,h=e.x+e.width,d=e.y+e.height;return a||(i=Object.assign({},i)),D.includes(t,e)?(s>e.x?i.x+=e.x-s:r<h&&(i.x+=h-r),n>e.y?i.y+=e.y-n:o<d&&(i.y+=d-o)):(s<e.x?i.x+=e.x-s:r>h&&(i.x+=h-r),n<e.y?i.y+=e.y-n:o>d&&(i.y+=d-o)),i}getPageMove(t){return this.assignMove(t),this.current.getPagePoint(N,null,!0)}getInnerMove(t,e){return t||(t=this.current),this.assignMove(e),t.getInnerPoint(N,null,!0)}getLocalMove(t,e){return t||(t=this.current),this.assignMove(e),t.getLocalPoint(N,null,!0)}getPageTotal(){return this.getPageMove(!0)}getInnerTotal(t){return this.getInnerMove(t,!0)}getLocalTotal(t){return this.getLocalMove(t,!0)}getPageBounds(){const t=this.getPageTotal(),e=this.getPagePoint(),i={};return D.set(i,e.x-t.x,e.y-t.y,t.x,t.y),D.unsign(i),i}assignMove(t){N.x=t?this.totalX:this.moveX,N.y=t?this.totalY:this.moveY}};W.BEFORE_DRAG="drag.before_drag",W.START="drag.start",W.DRAG="drag",W.END="drag.end",W.OVER="drag.over",W.OUT="drag.out",W.ENTER="drag.enter",W.LEAVE="drag.leave",W=L([_()],W);const F=W;let z=class extends B{static setList(t){W.setList(t)}static setData(t){W.setData(t)}};z.DROP="drop",z=L([_()],z);let V=class extends W{};V.BEFORE_MOVE="move.before_move",V.START="move.start",V.MOVE="move",V.END="move.end",V=L([_()],V);let j=class extends H{};j.BEFORE_ROTATE="rotate.before_rotate",j.START="rotate.start",j.ROTATE="rotate",j.END="rotate.end",j=L([_()],j);let K=class extends W{};K.SWIPE="swipe",K.LEFT="swipe.left",K.RIGHT="swipe.right",K.UP="swipe.up",K.DOWN="swipe.down",K=L([_()],K);let U=class extends H{};U.BEFORE_ZOOM="zoom.before_zoom",U.START="zoom.start",U.ZOOM="zoom",U.END="zoom.end",U=L([_()],U);let X=class extends H{};function Y(t){t.isApp||t.__eventIds.push(t.on_(V.BEFORE_MOVE,(e=>{t.zoomLayer.move(t.getValidMove(e.moveX,e.moveY))})),t.on_(U.BEFORE_ZOOM,(e=>{const{zoomLayer:i}=t,a=t.getValidScale(e.scale);1!==a&&(y.scaleOf(i,e,a),i.scale=i.__.scaleX*a)})))}X.DOWN="key.down",X.HOLD="key.hold",X.UP="key.up",X=L([_()],X);const G=c.get("LeaferTypeCreator"),Z={list:{},register(t,e){q[t]?G.repeat(t):q[t]=e},run(t,e){const i=q[t];i&&i(e)}},{list:q,register:J}=Z;J("design",Y),J("document",(function(t){Y(t);const{move:e,zoom:i}=t.config;e.scroll="limit",i.min=1})),J("block",(function(t){const{config:e}=t;(e.wheel||(e.wheel={})).preventDefault=!1,(e.touch||(e.touch={})).preventDefault="auto"}));const Q=t.prototype;Q.initType=function(t){Z.run(t,this)},Q.getValidMove=function(t,e){const{scroll:i,disabled:a}=this.app.config.move;if(i&&(Math.abs(t)>Math.abs(e)?e=0:t=0,"limit"===i)){const{x:i,y:a,width:s,height:n}=new E(this.__world).addPoint(this.zoomLayer),r=i+s-this.width,o=a+n-this.height;i>=0&&r<=0?t=0:t>0?i+t>0&&(t=-i):t<0&&r+t<0&&(t=-r),a>=0&&o<=0?e=0:e>0?a+e>0&&(e=-a):e<0&&o+e<0&&(e=-o)}return{x:a?0:t,y:a?0:e}},Q.getValidScale=function(t){const{scaleX:e}=this.zoomLayer.__,{min:i,max:a,disabled:s}=this.app.config.zoom,n=Math.abs(e*t);return n<i?t=i/e:n>a&&(t=a/e),s?1:t};class ${get transforming(){return!!(this.moveData||this.zoomData||this.rotateData)}constructor(t){this.interaction=t}move(t){const{interaction:e}=this;if(t.moveType||(t.moveType="move"),!this.moveData){const{path:i}=e.selector.getByPoint(t,e.hitRadius);t.path=i,this.moveData=Object.assign(Object.assign({},t),{moveX:0,moveY:0}),e.cancelHover(),e.emit(V.START,this.moveData)}t.path=this.moveData.path,e.emit(V.BEFORE_MOVE,t),e.emit(V.MOVE,t),this.transformEndWait()}zoom(t){const{interaction:e}=this;if(!this.zoomData){const{path:i}=e.selector.getByPoint(t,e.hitRadius);t.path=i,this.zoomData=Object.assign(Object.assign({},t),{scale:1}),e.cancelHover(),e.emit(U.START,this.zoomData)}t.path=this.zoomData.path,e.emit(U.BEFORE_ZOOM,t),e.emit(U.ZOOM,t),this.transformEndWait()}rotate(t){const{interaction:e}=this;if(!this.rotateData){const{path:i}=e.selector.getByPoint(t,e.hitRadius);t.path=i,this.rotateData=Object.assign(Object.assign({},t),{rotation:0}),e.cancelHover(),e.emit(j.START,this.rotateData)}t.path=this.rotateData.path,e.emit(j.BEFORE_ROTATE,t),e.emit(j.ROTATE,t),this.transformEndWait()}transformEndWait(){clearTimeout(this.transformTimer),this.transformTimer=setTimeout((()=>{this.transformEnd()}),this.interaction.config.pointer.transformTime)}transformEnd(){this.moveEnd(),this.zoomEnd(),this.rotateEnd()}moveEnd(){this.moveData&&(this.interaction.emit(V.END,this.moveData),this.moveData=null)}zoomEnd(){this.zoomData&&(this.interaction.emit(U.END,this.zoomData),this.zoomData=null)}rotateEnd(){this.rotateData&&(this.interaction.emit(j.END,this.rotateData),this.rotateData=null)}destroy(){this.zoomData=this.moveData=this.rotateData=null}}const tt={getMoveEventData:(t,e,i)=>Object.assign(Object.assign({},i),{x:t.x,y:t.y,moveX:e.x,moveY:e.y}),getRotateEventData:(t,e,i)=>Object.assign(Object.assign({},i),{x:t.x,y:t.y,rotation:e}),getZoomEventData:(t,e,i)=>Object.assign(Object.assign({},i),{x:t.x,y:t.y,scale:e}),getDragEventData:(t,e,i)=>Object.assign(Object.assign({},i),{x:i.x,y:i.y,moveX:i.x-e.x,moveY:i.y-e.y,totalX:i.x-t.x,totalY:i.y-t.y}),getDropEventData:(t,e,i)=>Object.assign(Object.assign({},t),{list:e,data:i}),getSwipeDirection:t=>t<-45&&t>-135?K.UP:t>45&&t<135?K.DOWN:t<=45&&t>=-45?K.RIGHT:K.LEFT,getSwipeEventData:(t,e,i)=>Object.assign(Object.assign({},i),{moveX:e.moveX,moveY:e.moveY,totalX:i.x-t.x,totalY:i.y-t.y,type:et.getSwipeDirection(y.getAngle(t,i))}),getBase(t){const e=1===t.button?4:t.button;return{altKey:t.altKey,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,metaKey:t.metaKey,buttons:void 0===t.buttons?1:0===t.buttons?e:t.buttons,origin:t}},pathHasEventType(t,e){const{list:i}=t;for(let t=0,a=i.length;t<a;t++)if(i[t].hasEvent(e))return!0;return!1},filterPathByEventType(t,e){const i=new f,{list:a}=t;for(let t=0,s=a.length;t<s;t++)a[t].hasEvent(e)&&i.add(a[t]);return i},pathCanDrag:t=>t&&t.list.some((t=>t.draggable||t.editable||!t.isLeafer&&t.hasEvent(W.DRAG))),pathHasOutside:t=>t&&t.list.some((t=>t.isOutside))},et=tt,it=new f,{getDragEventData:at,getDropEventData:st,getSwipeEventData:nt}=tt;class rt{constructor(t){this.interaction=t}setDragData(t){this.animateWait&&this.dragEndReal(),this.downData=this.interaction.downData,this.dragData=at(t,t,t),this.canAnimate=this.canDragOut=!0}getList(t,e){const{proxy:i}=this.interaction.selector,a=i&&i.list.length,s=W.list||this.draggableList||it;return this.dragging&&(a?t?it:new f(e?[...i.list,...i.dragHoverExclude]:i.list):s)}checkDrag(t,e){const{interaction:i}=this;if(this.moving&&t.buttons<1)return this.canAnimate=!1,void i.pointerCancel();!this.moving&&e&&(this.moving=i.canMove(this.downData)||i.isHoldRightKey||i.isMobileDragEmpty)&&(this.dragData.moveType="drag",i.emit(V.START,this.dragData)),this.moving||this.dragStart(t,e),this.drag(t)}dragStart(t,e){this.dragging||(this.dragging=e&&A.left(t),this.dragging&&(this.interaction.emit(W.START,this.dragData),this.getDraggableList(this.dragData.path),this.setDragStartPoints(this.realDraggableList=this.getList(!0))))}setDragStartPoints(t){this.dragStartPoints={},t.forEach((t=>this.dragStartPoints[t.innerId]={x:t.x,y:t.y}))}getDraggableList(t){let e;for(let i=0,a=t.length;i<a;i++)if(e=t.list[i],(e.draggable||e.editable)&&e.hitSelf&&!e.locked){this.draggableList=new f(e);break}}drag(t){const{interaction:e,dragData:i,downData:a}=this,{path:s,throughPath:n}=a;this.dragData=at(a,i,t),n&&(this.dragData.throughPath=n),this.dragData.path=s,this.moving?(this.dragData.moveType="drag",e.emit(V.BEFORE_MOVE,this.dragData),e.emit(V.MOVE,this.dragData)):this.dragging&&(this.dragReal(),e.emit(W.BEFORE_DRAG,this.dragData),e.emit(W.DRAG,this.dragData))}dragReal(){const{running:t}=this.interaction,e=this.realDraggableList;if(e.length&&t){const{totalX:t,totalY:i}=this.dragData;e.forEach((e=>e.draggable&&e.move(W.getValidMove(e,this.dragStartPoints[e.innerId],{x:t,y:i}))))}}dragOverOrOut(t){const{interaction:e}=this,{dragOverPath:i}=this,{path:a}=t;this.dragOverPath=a,i?a.indexAt(0)!==i.indexAt(0)&&(e.emit(W.OUT,t,i),e.emit(W.OVER,t,a)):e.emit(W.OVER,t,a)}dragEnterOrLeave(t){const{interaction:e}=this,{dragEnterPath:i}=this,{path:a}=t;e.emit(W.LEAVE,t,i,a),e.emit(W.ENTER,t,a,i),this.dragEnterPath=a}dragEnd(t,e){if(!this.dragging&&!this.moving)return;const{moveX:i,moveY:a}=this.dragData;this.interaction.config.move.dragAnimate&&this.canAnimate&&this.moving&&(Math.abs(i)>1||Math.abs(a)>1)?(t=Object.assign({},t),e=.9*(e||("touch"===t.pointerType?2:1)),y.move(t,i*e,a*e),this.drag(t),this.animate((()=>{this.dragEnd(t,1)}))):this.dragEndReal(t)}dragEndReal(t){const{interaction:e,downData:i,dragData:a}=this;t||(t=a);const{path:s,throughPath:n}=i,r=at(i,t,t);if(n&&(r.throughPath=n),r.path=s,this.moving&&(this.moving=!1,r.moveType="drag",e.emit(V.END,r)),this.dragging){const s=this.getList();this.dragging=!1,e.emit(W.END,r),this.swipe(t,i,a,r),this.drop(t,s,this.dragEnterPath)}this.autoMoveCancel(),this.dragReset(),this.animate(null,"off")}animate(t,e){const i=t||this.animateWait;i&&this.interaction.target.nextRender(i,null,e),this.animateWait=t}swipe(t,e,i,a){const{interaction:s}=this;if(y.getDistance(e,t)>s.config.pointer.swipeDistance){const t=nt(e,i,a);this.interaction.emit(t.type,t)}}drop(t,e,i){const a=st(t,e,W.data);a.path=i,this.interaction.emit(z.DROP,a),this.interaction.emit(W.LEAVE,t,i)}dragReset(){W.list=W.data=this.draggableList=this.dragData=this.downData=this.dragOverPath=this.dragEnterPath=null}checkDragOut(t){const{interaction:e}=this;this.autoMoveCancel(),this.dragging&&!e.shrinkCanvasBounds.hitPoint(t)&&this.autoMoveOnDragOut(t)}autoMoveOnDragOut(t){const{interaction:e,downData:i,canDragOut:a}=this,{autoDistance:s,dragOut:n}=e.config.move;if(!n||!a||!s)return;const r=e.shrinkCanvasBounds,{x:o,y:h}=r,d=D.maxX(r),c=D.maxY(r),l=t.x<o?s:d<t.x?-s:0,g=t.y<h?s:c<t.y?-s:0;let u=0,p=0;this.autoMoveTimer=setInterval((()=>{u+=l,p+=g,y.move(i,l,g),y.move(this.dragData,l,g),e.move(Object.assign(Object.assign({},t),{moveX:l,moveY:g,totalX:u,totalY:p,moveType:"drag"})),e.pointerMoveReal(t)}),10)}autoMoveCancel(){this.autoMoveTimer&&(clearInterval(this.autoMoveTimer),this.autoMoveTimer=0)}destroy(){this.dragReset()}}const ot=c.get("emit");const ht=["move","zoom","rotate","key"];function dt(t,e,i,a,s){if(ht.some((t=>e.startsWith(t)))&&t.__.hitChildren&&!lt(t,s)){let n;for(let r=0,o=t.children.length;r<o;r++)n=t.children[r],!i.path.has(n)&&n.__.hittable&&ct(n,e,i,a,s)}}function ct(t,i,a,s,n){if(t.destroyed)return!1;if(t.__.hitSelf&&!lt(t,n)&&(e.updateEventStyle&&!s&&e.updateEventStyle(t,i),t.hasEvent(i,s))){a.phase=s?1:t===a.target?2:3;const e=v.get(i,a);if(t.emitEvent(e,s),e.isStop)return!0}return!1}function lt(t,e){return e&&e.has(t)}const gt={getData(t){const e=t[0],i=t[1],a=y.getCenter(e.from,i.from),s=y.getCenter(e.to,i.to),n={x:s.x-a.x,y:s.y-a.y},r=y.getDistance(e.from,i.from);return{move:n,scale:y.getDistance(e.to,i.to)/r,angle:y.getRotation(e.from,i.from,e.to,i.to),center:s}}},ut={wheel:{zoomSpeed:.5,moveSpeed:.5,rotateSpeed:.5,delta:{x:20,y:8},preventDefault:!0},pointer:{hitRadius:5,tapTime:120,longPressTime:800,transformTime:500,hover:!0,dragHover:!0,dragDistance:2,swipeDistance:20,preventDefaultMenu:!0},touch:{preventDefault:!0},multiTouch:{},cursor:!0,keyEvent:!0},{pathHasEventType:pt,getMoveEventData:mt,getZoomEventData:vt,getRotateEventData:_t,pathCanDrag:ft,pathHasOutside:Dt}=tt;class yt{get dragging(){return this.dragger.dragging}get transforming(){return this.transformer.transforming}get moveMode(){return!0===this.config.move.drag||this.isHoldSpaceKey||this.isHoldMiddleKey||this.isHoldRightKey&&this.dragger.moving||this.isDragEmpty}get canHover(){return this.config.pointer.hover&&!this.config.mobile}get isDragEmpty(){return this.config.move.dragEmpty&&this.isRootPath(this.hoverData)&&(!this.downData||this.isRootPath(this.downData))}get isMobileDragEmpty(){return this.config.move.dragEmpty&&!this.canHover&&this.downData&&this.isTreePath(this.downData)}get isHoldMiddleKey(){return this.config.move.holdMiddleKey&&this.downData&&A.middle(this.downData)}get isHoldRightKey(){return this.config.move.holdRightKey&&this.downData&&A.right(this.downData)}get isHoldSpaceKey(){return this.config.move.holdSpaceKey&&k.isHoldSpaceKey()}get hitRadius(){return this.config.pointer.hitRadius}constructor(t,e,i,a){this.config=l.clone(ut),this.tapCount=0,this.downKeyMap={},this.target=t,this.canvas=e,this.selector=i,this.defaultPath=new f(t),this.transformer=new $(this),this.dragger=new rt(this),a&&(this.config=l.default(a,this.config)),this.__listenEvents()}start(){this.running=!0}stop(){this.running=!1}receive(t){}pointerDown(t,e){t||(t=this.hoverData),t&&(A.defaultLeft(t),this.updateDownData(t),this.checkPath(t,e),this.downTime=Date.now(),this.emit(B.BEFORE_DOWN,t),this.emit(B.DOWN,t),A.left(t)&&(this.tapWait(),this.longPressWait(t)),this.waitRightTap=A.right(t),this.dragger.setDragData(t),this.isHoldRightKey||this.updateCursor(t))}pointerMove(t){if(t||(t=this.hoverData),!t)return;const{downData:e}=this;e&&A.defaultLeft(t);(this.canvas.bounds.hitPoint(t)||e)&&(this.pointerMoveReal(t),e&&this.dragger.checkDragOut(t))}pointerMoveReal(t){const{dragHover:e,dragDistance:i}=this.config.pointer;if(this.emit(B.BEFORE_MOVE,t,this.defaultPath),this.downData){const e=y.getDistance(this.downData,t)>i;e&&(this.waitTap&&this.pointerWaitCancel(),this.waitRightTap=!1),this.dragger.checkDrag(t,e)}this.dragger.moving||(this.updateHoverData(t),this.checkPath(t),this.emit(B.MOVE,t),this.dragging&&!e||this.pointerHover(t),this.dragger.dragging&&(this.dragger.dragOverOrOut(t),this.dragger.dragEnterOrLeave(t))),this.updateCursor(this.downData||t)}pointerUp(t){const{downData:e}=this;if(t||(t=e),!e)return;A.defaultLeft(t),t.multiTouch=e.multiTouch,this.findPath(t);const i=Object.assign(Object.assign({},t),{path:t.path.clone()});t.path.addList(e.path.list),this.checkPath(t),this.downData=null,this.emit(B.BEFORE_UP,t),this.emit(B.UP,t),this.touchLeave(t),t.isCancel||(this.tap(t),this.menuTap(t)),this.dragger.dragEnd(t),this.updateCursor(i)}pointerCancel(){const t=Object.assign({},this.dragger.dragData);t.isCancel=!0,this.pointerUp(t)}multiTouch(t,e){if(this.config.multiTouch.disabled)return;const{move:i,angle:a,scale:s,center:n}=gt.getData(e);this.rotate(_t(n,a,t)),this.zoom(vt(n,s,t)),this.move(mt(n,i,t))}menu(t){this.findPath(t),this.emit(B.MENU,t),this.waitMenuTap=!0,!this.downData&&this.waitRightTap&&this.menuTap(t)}menuTap(t){this.waitRightTap&&this.waitMenuTap&&(this.emit(B.MENU_TAP,t),this.waitRightTap=this.waitMenuTap=!1)}move(t){this.transformer.move(t)}zoom(t){this.transformer.zoom(t)}rotate(t){this.transformer.rotate(t)}transformEnd(){this.transformer.transformEnd()}keyDown(t){if(!this.config.keyEvent)return;const{code:e}=t;this.downKeyMap[e]||(this.downKeyMap[e]=!0,k.setDownCode(e),this.emit(X.HOLD,t,this.defaultPath),this.moveMode&&(this.cancelHover(),this.updateCursor())),this.emit(X.DOWN,t,this.defaultPath)}keyUp(t){if(!this.config.keyEvent)return;const{code:e}=t;this.downKeyMap[e]=!1,k.setUpCode(e),this.emit(X.UP,t,this.defaultPath),"grab"===this.cursor&&this.updateCursor()}pointerHover(t){this.canHover&&(this.pointerOverOrOut(t),this.pointerEnterOrLeave(t))}pointerOverOrOut(t){const{path:e}=t,{overPath:i}=this;this.overPath=e,i?e.indexAt(0)!==i.indexAt(0)&&(this.emit(B.OUT,t,i),this.emit(B.OVER,t,e)):this.emit(B.OVER,t,e)}pointerEnterOrLeave(t){let{path:e}=t;this.downData&&!this.moveMode&&(e=e.clone(),this.downData.path.forEach((t=>e.add(t))));const{enterPath:i}=this;this.enterPath=e,this.emit(B.LEAVE,t,i,e),this.emit(B.ENTER,t,e,i)}touchLeave(t){"touch"===t.pointerType&&this.enterPath&&(this.emit(B.LEAVE,t),this.dragger.dragging&&this.emit(z.LEAVE,t))}tap(t){const{pointer:e}=this.config,i=this.longTap(t);if(!e.tapMore&&i)return;if(!this.waitTap)return;e.tapMore&&this.emitTap(t);const a=Date.now()-this.downTime,s=[B.DOUBLE_TAP,B.DOUBLE_CLICK].some((e=>pt(t.path,e)));a<e.tapTime+50&&s?(this.tapCount++,2===this.tapCount?(this.tapWaitCancel(),this.emitDoubleTap(t)):(clearTimeout(this.tapTimer),this.tapTimer=setTimeout((()=>{e.tapMore||(this.tapWaitCancel(),this.emitTap(t))}),e.tapTime))):e.tapMore||(this.tapWaitCancel(),this.emitTap(t))}findPath(t,e){const{hitRadius:i,through:a}=this.config.pointer,{bottomList:s}=this,n=this.selector.getByPoint(t,i,Object.assign({bottomList:s,name:t.type},e||{through:a}));return n.throughPath&&(t.throughPath=n.throughPath),t.path=n.path,n.path}isRootPath(t){return t&&t.path.list[0].isLeafer}isTreePath(t){const e=this.target.app;return!(!e||!e.isApp)&&(e.editor&&!t.path.has(e.editor)&&t.path.has(e.tree)&&!t.target.syncEventer)}checkPath(t,e){(e||this.moveMode&&!Dt(t.path))&&(t.path=this.defaultPath)}canMove(t){return t&&(this.moveMode||"auto"===this.config.move.drag&&!ft(t.path))&&!Dt(t.path)}isDrag(t){return this.dragger.getList().has(t)}isPress(t){return this.downData&&this.downData.path.has(t)}isHover(t){return this.enterPath&&this.enterPath.has(t)}isFocus(t){return this.focusData===t}cancelHover(){const{hoverData:t}=this;t&&(t.path=this.defaultPath,this.pointerHover(t))}updateDownData(t,e,i){const{downData:a}=this;!t&&a&&(t=a),t&&(this.findPath(t,e),i&&a&&t.path.addList(a.path.list),this.downData=t)}updateHoverData(t){t||(t=this.hoverData),t&&(this.findPath(t,{exclude:this.dragger.getList(!1,!0),name:B.MOVE}),this.hoverData=t)}updateCursor(t){if(!this.config.cursor||!this.canHover)return;if(t||(this.updateHoverData(),t=this.downData||this.hoverData),this.dragger.moving)return this.setCursor("grabbing");if(this.canMove(t))return this.setCursor(this.downData?"grabbing":"grab");if(!t)return;let e,i;const{path:a}=t;for(let t=0,s=a.length;t<s&&(e=a.list[t],i=e.syncEventer&&e.syncEventer.cursor||e.cursor,!i);t++);this.setCursor(i)}setCursor(t){this.cursor=t}getLocal(t,e){const i=this.canvas.getClientBounds(e);return{x:t.clientX-i.x,y:t.clientY-i.y}}emitTap(t){this.emit(B.TAP,t),this.emit(B.CLICK,t)}emitDoubleTap(t){this.emit(B.DOUBLE_TAP,t),this.emit(B.DOUBLE_CLICK,t)}pointerWaitCancel(){this.tapWaitCancel(),this.longPressWaitCancel()}tapWait(){clearTimeout(this.tapTimer),this.waitTap=!0}tapWaitCancel(){clearTimeout(this.tapTimer),this.waitTap=!1,this.tapCount=0}longPressWait(t){clearTimeout(this.longPressTimer),this.longPressTimer=setTimeout((()=>{this.longPressed=!0,this.emit(B.LONG_PRESS,t)}),this.config.pointer.longPressTime)}longTap(t){let e;return this.longPressed&&(this.emit(B.LONG_TAP,t),(pt(t.path,B.LONG_TAP)||pt(t.path,B.LONG_PRESS))&&(e=!0)),this.longPressWaitCancel(),e}longPressWaitCancel(){clearTimeout(this.longPressTimer),this.longPressed=!1}__onResize(){this.shrinkCanvasBounds=new E(this.canvas.bounds),this.shrinkCanvasBounds.spread(-2)}__listenEvents(){const{target:t}=this;this.__eventIds=[t.on_(P.RESIZE,this.__onResize,this)],t.once(O.READY,(()=>this.__onResize()))}__removeListenEvents(){this.target.off_(this.__eventIds),this.__eventIds.length=0}emit(t,e,i,a){this.running&&function(t,e,i,a){if(!i&&!e.path)return;let s;e.type=t,i?e=Object.assign(Object.assign({},e),{path:i}):i=e.path,e.target=i.indexAt(0);try{for(let n=i.length-1;n>-1;n--){if(s=i.list[n],ct(s,t,e,!0,a))return;s.isApp&&dt(s,t,e,!0,a)}for(let n=0,r=i.length;n<r;n++)if(s=i.list[n],s.isApp&&dt(s,t,e,!1,a),ct(s,t,e,!1,a))return}catch(t){ot.error(t)}}(t,e,i,a)}destroy(){this.__eventIds.length&&(this.stop(),this.__removeListenEvents(),this.dragger.destroy(),this.transformer.destroy(),this.downData=this.overPath=this.enterPath=null)}}class Et{static set(t,e){this.custom[t]=e}static get(t){return this.custom[t]}}Et.custom={};class Pt extends T{constructor(){super(...arguments),this.maxTotal=1e3,this.pathList=new f,this.pixelList=new f}getPixelType(t,e){return this.__autoClear(),this.pixelList.add(t),h.hitCanvas(e)}getPathType(t){return this.__autoClear(),this.pathList.add(t),h.hitCanvas()}clearImageType(){this.__clearLeafList(this.pixelList)}clearPathType(){this.__clearLeafList(this.pathList)}__clearLeafList(t){t.length&&(t.forEach((t=>{t.__hitCanvas&&(t.__hitCanvas.destroy(),t.__hitCanvas=null)})),t.reset())}__autoClear(){this.pathList.length+this.pixelList.length>this.maxTotal&&this.clear()}clear(){this.clearPathType(),this.clearImageType()}}const{toInnerRadiusPointOf:Ot,copy:Tt,setRadius:wt}=y,Rt={},xt=w.prototype;xt.__hitWorld=function(t){if(!this.__.hitSelf)return!1;this.__.hitRadius&&(Tt(Rt,t),wt(t=Rt,this.__.hitRadius)),Ot(t,this.__world,Rt);const{width:e,height:i}=this.__world,a=e<10&&i<10;if(this.__.hitBox||a){if(D.hitRadiusPoint(this.__layout.boxBounds,Rt))return!0;if(a)return!1}return!this.__layout.hitCanvasChanged&&this.__hitCanvas||(this.__updateHitCanvas(),this.__layout.boundsChanged||(this.__layout.hitCanvasChanged=!1)),this.__hit(Rt)},xt.__hitFill=function(t){var e;return null===(e=this.__hitCanvas)||void 0===e?void 0:e.hitFill(t,this.__.windingRule)},xt.__hitStroke=function(t,e){var i;return null===(i=this.__hitCanvas)||void 0===i?void 0:i.hitStroke(t,e)},xt.__hitPixel=function(t){var e;return null===(e=this.__hitCanvas)||void 0===e?void 0:e.hitPixel(t,this.__layout.renderBounds,this.__hitCanvas.hitScale)},xt.__drawHitPath=function(t){t&&this.__drawRenderPath(t)};const Ct=new R,bt=i.prototype;bt.__updateHitCanvas=function(){const t=this.__,{hitCanvasManager:e}=this.leafer,i=(t.__pixelFill||t.__isCanvas)&&"pixel"===t.hitFill,s=t.__pixelStroke&&"pixel"===t.hitStroke,n=i||s;this.__hitCanvas||(this.__hitCanvas=n?e.getPixelType(this,{contextSettings:{willReadFrequently:!0}}):e.getPathType(this));const r=this.__hitCanvas;if(n){const{renderBounds:e}=this.__layout,n=x.image.hitCanvasSize,o=r.hitScale=C.set(0,0,n,n).getFitMatrix(e).a,{x:h,y:d,width:c,height:l}=C.set(e).scale(o);r.resize({width:c,height:l,pixelRatio:1}),r.clear(),a.patternLocked=!0,this.__renderShape(r,{matrix:Ct.setWith(this.__world).scaleWith(1/o).invertWith().translate(-h,-d)},!i,!s),a.patternLocked=!1,r.resetTransform(),t.__isHitPixel=!0}else t.__isHitPixel&&(t.__isHitPixel=!1);this.__drawHitPath(r),r.setStrokeOptions(t)},bt.__hit=function(t){"miniapp"===x.name&&this.__drawHitPath(this.__hitCanvas);const e=this.__;if(e.__isHitPixel&&this.__hitPixel(t))return!0;const{hitFill:i}=e,a=(e.fill||e.__isCanvas)&&("path"===i||"pixel"===i&&!(e.__pixelFill||e.__isCanvas))||"all"===i;if(a&&this.__hitFill(t))return!0;const{hitStroke:s,__strokeWidth:n}=e,r=e.stroke&&("path"===s||"pixel"===s&&!e.__pixelStroke)||"all"===s;if(!a&&!r)return!1;const o=2*t.radiusX;let h=o;if(r)switch(e.strokeAlign){case"inside":if(h+=2*n,!a&&this.__hitFill(t)&&this.__hitStroke(t,h))return!0;h=o;break;case"center":h+=n;break;case"outside":if(h+=2*n,!a){if(!this.__hitFill(t)&&this.__hitStroke(t,h))return!0;h=o}}return!!h&&this.__hitStroke(t,h)};const Lt=i.prototype,Mt=s.prototype,St=n.prototype;Mt.__updateHitCanvas=St.__updateHitCanvas=function(){this.stroke||this.cornerRadius||(this.fill||this.__.__isCanvas)&&"pixel"===this.hitFill||"all"===this.hitStroke?Lt.__updateHitCanvas.call(this):this.__hitCanvas&&(this.__hitCanvas=null)},Mt.__hitFill=St.__hitFill=function(t){return this.__hitCanvas?Lt.__hitFill.call(this,t):D.hitRadiusPoint(this.__layout.boxBounds,t)};const kt=i.prototype,At=r.prototype;kt.find=function(t,e){return this.leafer?this.leafer.selector.getBy(t,this,!1,e):[]},kt.findOne=function(t,e){return this.leafer?this.leafer.selector.getBy(t,this,!0,e):null},At.pick=function(t,e){return this.__layout.update(),e||(e={}),this.leafer?this.leafer.selector.getByPoint(t,e.hitRadius||0,Object.assign(Object.assign({},e),{target:this})):null};const Ht=b.prototype;Ht.hitFill=function(t,e){return e?this.context.isPointInPath(t.x,t.y,e):this.context.isPointInPath(t.x,t.y)},Ht.hitStroke=function(t,e){return this.strokeWidth=e,this.context.isPointInStroke(t.x,t.y)},Ht.hitPixel=function(t,e,i=1){let{x:a,y:s,radiusX:n,radiusY:r}=t;e&&(a-=e.x,s-=e.y),C.set(a-n,s-r,2*n,2*r).scale(i).ceil();const{data:o}=this.context.getImageData(C.x,C.y,C.width||1,C.height||1);for(let t=0,e=o.length;t<e;t+=4)if(o[t+3]>0)return!0;return o[3]>0};export{M as App,Et as Cursor,W as DragEvent,z as DropEvent,Pt as HitCanvasManager,yt as InteractionBase,tt as InteractionHelper,X as KeyEvent,k as Keyboard,Z as LeaferTypeCreator,V as MoveEvent,gt as MultiTouchHelper,F as MyDragEvent,I as MyPointerEvent,A as PointerButton,B as PointerEvent,j as RotateEvent,K as SwipeEvent,H as UIEvent,U as ZoomEvent,Y as addInteractionWindow};
